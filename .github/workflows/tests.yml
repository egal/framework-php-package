name: Tests

on:
  pull_request: { }

jobs:

  PHPUnit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Composer
        run: |
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            --workdir "/app" \
            --volume "${PWD}:/app" \
            composer install \
              --dev \
              --ignore-platform-reqs \
              --no-interaction
      - name: Run a PHPUnit
        run: |
          bash bin/phpunit.sh

  PHPCS:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 2
      - name: Install Composer
        run: |
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            --workdir "/app" \
            --volume "${PWD}:/app" \
            composer install \
              --dev \
              --ignore-platform-reqs \
              --no-interaction
      - name: Run a PHPCS
        run: |
          git diff --name-only --diff-filter=dr ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '(.php)$'
          bash bin/phpcs.sh $(git diff --name-only --diff-filter=dr ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '(.php)$')
