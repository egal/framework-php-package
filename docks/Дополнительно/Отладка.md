В процессе работы с фреймворком всегда возникают какие-либо сложности поиска информации по тому, что и как внутри происходит. Здесь рассмотрим источники информации о состоянии системы и происходящих внутри процессах, как и где искать данные об ошибках и информацию о состоянии системы.

Ссылки, приведённые в данной статье читать необходимо, т.к. они дают более обширную информацию и понимание того что происходит.

## Источники информации

Большинство проблем и ошибок можно разобрать, обратившись к системе. Это:

* Логи фреймворка
* Логи сервисов
* Логи самой операционной системы
* Консоль / терминал Linux

### Логи фреймворка

Логи фреймворка хранятся в директории микросервиса, в директории storage/logs. Они содержат максимум информации об ошибках php и именуются с текущей датой. Прежде чем лезть в гугл, стоит посмотреть туда и проанализировать код на ошибки.

### Логи сервисов

Логи сервисов как лежат в /var/log. Сервисы, которые касаются фреймворка, складируют логи именно там. Нас касаются логи трёх сервисов: это nginx, unit и supervisor.

Веб-сервер nginx запускается в отдельном контейнере, по-умолчанию он называется frontend. Этот сервис проксирует запросы на сервис unit, который, в свою очередь, обслуживает проксирующий сервис web. Туда, как правило, стоит лезть в том случае, если меняется конфигурация сервиса nginx или чтобы проверить что запросы доходят до сервиса unit. Логи nginx хранятся в /var/log/nginx.

Сервер unit - это сервер приложений, который обслуживает сервис web. Сервис web берёт HTTP запросы пользователя, переформатирует их и складывает в очередь сообщений, которую обрабатывают демоны фреймворка, после этого ждёт ответа от сервиса и отправляет пользователю. Если демон вернул данные - значит всё хорошо, иначе выдаётся ошибка 500. По-умолчанию сервис unit и демоны фреймворка работают в контейнере backend.

Логи сервера unit хранятся в /var/log/unit.log. Туда стоит идти только в случае, если сбоит сервис web. Это бывает крайне редко, а ошибка 500 - вряд ли косяк сервиса web, скорее всего попросту не работает или слишком долго отвечает демон фреймворка.

### Логи операционной системы

Логи операционной системы лежат в /var/log. Туда заходить нужно очень редко, в случае, если не получилось получить информацию из других источников и происходит [нечто невообразимое](http://lurkmore.to/%D0%9D%D1%91%D1%85).

Фреймворк работает в контейнере докера. Это значит, что внутри вашей операционной системы есть контейнеры, в которых запускаются сервисы отдельно от родительской операционной системы. То есть, контейнер контейнер имеет свою файловую систему, отдельную от родительской ОС, и, как следствие, свой /var/log. Подробнее про контейнеры нужно читать [тут](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F).

Операционная система пишет обычно в messages и syslog. Информация о состоянии системы доступна только привилегированному пользователю, поэтому чтобы на них посмотреть, нужно зайти под пользователем root.

В хост-системе это делается командой: `sudo -i`, дальше нужно ввести свой пароль и приглашение командной строки будет выглядеть примерно так:

`root@hostname:~#`

Для входа в контейнер под суперпользователем нужно выполнить команду `vmng root containerName`, где containerName - это имя контейнера.

Стоит иметь ввиду, что из-под суперпользователя можно делать только:

* Установка пакетов
* Просмотр системных логов
* Правка конфигурации ОС

Всё остальное делать только из-под обычного пользователя.

## Отладка

Если произошла какая-то ошибка, нужно в первую очередь знать [как запускается фреймворк и как это делать правильно](/Документация/Работа-с-фреймворком). Сервис может быть запущен как демон или из консоли вручную.

### Демон

Если сервис работает как отдельный самостоятельный демон, то получить подробную информацию по его работе можно только из файлов лога. Когда демон запускается - запускается мастер-процесс, он запускает дополнительные дочерние процессы, которые прослушивают очереди. Этот способ запуска не подходит для подробной отладки. В качестве демона лучше всего запускать протестированные и отлаженные сервисы.

Если демон не запускается, нужно убедиться в том, что нет pid-файла в директории storage/app. Если pid-файл существует, нужно убедиться что демон не запущен. Если запустить несколько экземпляров демона одного сервиса, то свеженаписанный код не будет обрабатываться старыми процессами, а ошибки будут случайными - то они есть, то их нет. Это происходит потому что каждую отдельную очередь должен обрабатывать только один демон, если их несколько - тогда они будут обрабатывать их по случайной очереди. Если процессов точно нет - это значит что надо удалить pid-файл и тогда запустить демона.

Тут стоит иметь ввиду, что если существует несколько контейнеров, запускающих один и тот же проект, то будут конфликты с pid-файлом.

Для просмотра запущенных процессов используется команда ps ax. Чтобы отфильтровать по демонам, нужно использовать grep artisan через unix-канал. То есть ps ax | grep artisan. Это можно делать как на хост-машине, так и в контейнерах. На хост-машине отобразятся все процессы из всех контейнеров.

### Консоль

Проще всего вести отладку в консоли. Запустить отдельную очередь можно командой `artisan mq:run queueName`. Для конкретной модели очередь запускается так: возьмём, к примеру, модель User: artisan mq:run _model_User. Вот тут критические ошибки будут сыпаться прямо в консоль и можно делать print_r, var_dump и иже с ними для проверки различных состояний системы.

Стоит иметь ввиду, что API формируется динамически. При загрузке мастер-процесса сканируется весь код на наличие точек входа и формируется API, которое сохраняется в редисе. Если добавлена новая точка входа API, стоит запустить мастер процесс для формирования API, остановить, и только после этого запускать отдельные очереди для тестирования.

В консоли также можно провести тестирование кода при помощи консольных команд Laravel. А лучше всего использовать unit-тестирование, создавая тесты в директории tests. Это самый надёжный способ проверить работоспособность кода до попадания его в отдел тестирования. Как тестировать написано в [документации Lumen](https://lumen.laravel.com/docs/7.x/testing).

## Поиск возможностей

Фреймворк обладает достаточно широкими возможностями. Основную информацию можно получить из [документации Egal Framework](https://gitlab.smartworld.team:3443/egal-framework/framework/-/wikis/home). Так как фреймворк базируется на фреймворке Lumen, то поможет документация по фреймворку [Lumen](https://lumen.laravel.com/docs/7.x) и [Laravel](https://laravel.com/docs/7.x). Дополнительно можно смотреть README.md и код библиотек для получения информации по функционалу каждой из библиотек, ссылки на них есть на [первой странице вики](home). Вся, или почти вся, информация по обновлениям выкладывается в канале фреймворка в рокет-чате. Если ничего не помогло - спросить у коллег и своего непосредственного руководителя, а потом уже обращаться к разработчикам фреймворка.

Поиск по коду и ошибкам фреймворка в интернете ни к чему не приведёт, т.к. он не используется на текущий момент нигде кроме как в нашей компании. Учитесь искать ошибки сами, а не гуглить уже готовые решения. А бездумная копипаста из интернета может привести к ещё более худшим ошибкам.